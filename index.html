<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ í”„ë¡œê·¸ë¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            max-width: 1200px;
            width: 100%;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-wrapper {
            position: relative;
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
        }

        .upload-button {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            border: none;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .file-input {
            position: absolute;
            width: 0;
            height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.success {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%);
            color: #22543d;
            border: 1px solid rgba(72, 187, 120, 0.3);
            display: block;
        }

        .status.error {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(237, 64, 64, 0.1) 100%);
            color: #742a2a;
            border: 1px solid rgba(245, 101, 101, 0.3);
            display: block;
        }

        .status.processing {
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.1) 0%, rgba(49, 130, 206, 0.1) 100%);
            color: #2c5282;
            border: 1px solid rgba(66, 153, 225, 0.3);
            display: block;
        }

        .info-box {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .info-box ul {
            list-style: none;
            color: #666;
            font-size: 14px;
            line-height: 1.8;
        }

        .info-box ul li:before {
            content: "âœ“ ";
            color: #667eea;
            font-weight: bold;
            margin-right: 5px;
        }

        .color-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .loader {
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .stats-box h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-item {
            padding: 8px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 5px;
            font-size: 14px;
        }

        .stat-label {
            color: #888;
            font-size: 12px;
        }

        .stat-value {
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- ì²« ë²ˆì§¸ í”„ë¡œê·¸ë¨: ì†”íŒ… -->
        <div class="container">
            <h1>ğŸ“Š ì—‘ì…€ íŒŒì¼ ì†”íŒ… í”„ë¡œê·¸ë¨</h1>
            
            <div class="info-box">
                <h3>ì²˜ë¦¬ ë‚´ìš©</h3>
                <ul>
                    <li>All ì‹œíŠ¸ì—ì„œ í•„ìš”í•œ ì—´ë§Œ ì¶”ì¶œ</li>
                    <li>ë³´ì¡´ ì—´: Id, ë‚˜ì´í‚¤, 250821, í™ê¸¸ë™, 010 1234 5678</li>
                    <li>ì—´ ì´ë¦„ ë³€ê²½: ë‚˜ì´í‚¤â†’íŒ€ì¥ì´ë¦„, 250821â†’ìƒë…„ì›”ì¼, í™ê¸¸ë™â†’íŒ€ì›ì´ë¦„, 010 1234 5678â†’ì „í™”ë²ˆí˜¸</li>
                    <li>íŒŒì¼ëª…ì— "_ì†”íŒ…" ì¶”ê°€</li>
                </ul>
            </div>

            <div class="upload-wrapper">
                <div class="upload-area" id="uploadArea1">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
                    <label for="fileInput1" class="upload-button">íŒŒì¼ ì„ íƒ</label>
                </div>
                <input type="file" id="fileInput1" class="file-input" accept=".xlsx,.xls">
            </div>

            <div id="status1" class="status"></div>
        </div>

        <!-- ë‘ ë²ˆì§¸ í”„ë¡œê·¸ë¨: ì¤‘ë³µ ê²€ì‚¬ -->
        <div class="container">
            <h2>ğŸ” ì¤‘ë³µ ë° ì˜¤ë¥˜ ê²€ì‚¬ í”„ë¡œê·¸ë¨</h2>
            
            <div class="info-box">
                <h3>ê²€ì‚¬ í•­ëª© ë° ìƒ‰ìƒ í‘œì‹œ</h3>
                <div class="color-legend">
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #FF6B6B;"></div>
                        <span>íŒ€ì¥ì´ë¦„ ì¤‘ë³µ (ë¹¨ê°•)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #51CF66;"></div>
                        <span>ë¯¸ì„±ë…„ì/ì˜ëª»ëœ ìƒë…„ì›”ì¼ (ë…¹ìƒ‰)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #FFD93D;"></div>
                        <span>íŒ€ì¥/íŒ€ì› ì´ë¦„ ë™ì¼ (ë…¸ë‘)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #B197FC;"></div>
                        <span>ì˜ëª»ëœ ì „í™”ë²ˆí˜¸ (ë³´ë¼)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #8B6835;"></div>
                        <span>ë³µí•© ì˜¤ë¥˜ (ê°ˆìƒ‰)</span>
                    </div>
                </div>
            </div>

            <div class="upload-wrapper">
                <div class="upload-area" id="uploadArea2">
                    <div class="upload-icon">ğŸ“‹</div>
                    <div class="upload-text">ì†”íŒ…ëœ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</div>
                    <label for="fileInput2" class="upload-button">íŒŒì¼ ì„ íƒ</label>
                </div>
                <input type="file" id="fileInput2" class="file-input" accept=".xlsx,.xls">
            </div>

            <div id="status2" class="status"></div>
            <div id="statsBox" class="stats-box" style="display: none;">
                <h4>ê²€ì‚¬ ê²°ê³¼ í†µê³„</h4>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë°©ì§€
        window.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, false);
        
        window.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, false);

        // ì²« ë²ˆì§¸ í”„ë¡œê·¸ë¨ (ì†”íŒ…)
        const uploadArea1 = document.getElementById('uploadArea1');
        const fileInput1 = document.getElementById('fileInput1');
        const statusDiv1 = document.getElementById('status1');

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        fileInput1.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleSortingFile(e.target.files[0]);
            }
        });

        // ë“œë˜ê·¸ ì˜¤ë²„
        uploadArea1.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea1.classList.add('dragover');
        });

        // ë“œë˜ê·¸ ë– ë‚¨
        uploadArea1.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea1.classList.remove('dragover');
        });

        // ë“œë¡­
        uploadArea1.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea1.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                handleSortingFile(files[0]);
            }
        });

        function showStatus1(message, type) {
            statusDiv1.className = `status ${type}`;
            statusDiv1.innerHTML = message;
        }

        function handleSortingFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus1('âŒ ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            showStatus1('<div class="loader"></div>íŒŒì¼ ì²˜ë¦¬ ì¤‘...', 'processing');

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    
                    if (!workbook.Sheets['All']) {
                        showStatus1('âŒ "All" ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                    
                    const allSheet = workbook.Sheets['All'];
                    const jsonData = XLSX.utils.sheet_to_json(allSheet, { header: 1 });
                    
                    if (jsonData.length === 0) {
                        showStatus1('âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                    
                    const headers = jsonData[0];
                    const columnsToKeep = ['Id', 'ë‚˜ì´í‚¤', '250821', 'í™ê¸¸ë™', '010 1234 5678'];
                    const columnIndices = [];
                    const columnMapping = {};
                    
                    columnsToKeep.forEach(colName => {
                        const index = headers.findIndex(header => {
                            if (!header) return false;
                            const headerStr = header.toString().trim();
                            return headerStr === colName || 
                                   headerStr.includes(colName) || 
                                   colName.includes(headerStr);
                        });
                        
                        if (index !== -1) {
                            columnIndices.push(index);
                            columnMapping[index] = colName;
                        }
                    });
                    
                    if (columnIndices.length === 0) {
                        showStatus1('âŒ í•„ìš”í•œ ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                    
                    const newData = [];
                    const newHeaders = columnIndices.map(index => {
                        const originalHeader = headers[index];
                        const mappedName = columnMapping[index];
                        
                        if (originalHeader.toString().includes('ë‚˜ì´í‚¤') || mappedName === 'ë‚˜ì´í‚¤') {
                            return 'íŒ€ì¥ì´ë¦„';
                        } else if (originalHeader.toString().includes('250821') || mappedName === '250821') {
                            return 'ìƒë…„ì›”ì¼';
                        } else if (originalHeader.toString().includes('í™ê¸¸ë™') || mappedName === 'í™ê¸¸ë™') {
                            return 'íŒ€ì›ì´ë¦„';
                        } else if (originalHeader.toString().includes('010') || mappedName === '010 1234 5678') {
                            return 'ì „í™”ë²ˆí˜¸';
                        } else {
                            return originalHeader;
                        }
                    });
                    
                    newData.push(newHeaders);
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const newRow = columnIndices.map(index => row[index] || '');
                        newData.push(newRow);
                    }
                    
                    const newWorkbook = XLSX.utils.book_new();
                    const newWorksheet = XLSX.utils.aoa_to_sheet(newData);
                    
                    const colWidths = newHeaders.map((header, i) => {
                        let maxLength = header.length;
                        for (let j = 1; j < newData.length; j++) {
                            const cellValue = newData[j][i];
                            if (cellValue && cellValue.toString().length > maxLength) {
                                maxLength = cellValue.toString().length;
                            }
                        }
                        return { wch: Math.min(maxLength + 2, 50) };
                    });
                    newWorksheet['!cols'] = colWidths;
                    
                    XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'All');
                    
                    const newFileName = file.name.replace(/\.(xlsx|xls)$/, '_ì†”íŒ….xlsx');
                    XLSX.writeFile(newWorkbook, newFileName);
                    
                    showStatus1(`âœ… íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ! "${newFileName}" ë‹¤ìš´ë¡œë“œë¨<br>ì²˜ë¦¬ëœ ì—´: ${columnIndices.length}ê°œ`, 'success');
                    
                } catch (error) {
                    console.error('Error:', error);
                    showStatus1(`âŒ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus1('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨', 'error');
            };
            
            reader.readAsBinaryString(file);
        }

        // ë‘ ë²ˆì§¸ í”„ë¡œê·¸ë¨ (ì¤‘ë³µ ê²€ì‚¬)
        const uploadArea2 = document.getElementById('uploadArea2');
        const fileInput2 = document.getElementById('fileInput2');
        const statusDiv2 = document.getElementById('status2');
        const statsBox = document.getElementById('statsBox');
        const statsGrid = document.getElementById('statsGrid');

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        fileInput2.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleDuplicateCheck(e.target.files[0]);
            }
        });

        // ë“œë˜ê·¸ ì˜¤ë²„
        uploadArea2.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea2.classList.add('dragover');
        });

        // ë“œë˜ê·¸ ë– ë‚¨
        uploadArea2.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea2.classList.remove('dragover');
        });

        // ë“œë¡­
        uploadArea2.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea2.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                handleDuplicateCheck(files[0]);
            }
        });

        function showStatus2(message, type) {
            statusDiv2.className = `status ${type}`;
            statusDiv2.innerHTML = message;
        }

        function handleDuplicateCheck(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus2('âŒ ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            showStatus2('<div class="loader"></div>ì¤‘ë³µ ë° ì˜¤ë¥˜ ê²€ì‚¬ ì¤‘...', 'processing');

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { 
                        type: 'binary'
                    });
                    
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    
                    if (jsonData.length === 0) {
                        showStatus2('âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                    
                    const headers = jsonData[0];
                    
                    // ì—´ ì¸ë±ìŠ¤ ì°¾ê¸°
                    const colIndices = {
                        id: headers.findIndex(h => h && h.toString().includes('Id')),
                        teamLeader: headers.findIndex(h => h && h.toString().includes('íŒ€ì¥ì´ë¦„')),
                        birthDate: headers.findIndex(h => h && h.toString().includes('ìƒë…„ì›”ì¼')),
                        teamMember: headers.findIndex(h => h && h.toString().includes('íŒ€ì›ì´ë¦„')),
                        phone: headers.findIndex(h => h && h.toString().includes('ì „í™”ë²ˆí˜¸'))
                    };
                    
                    // í†µê³„ ì´ˆê¸°í™”
                    const stats = {
                        total: jsonData.length - 1,
                        duplicateLeader: 0,
                        minor: 0,
                        sameNames: 0,
                        wrongPhone: 0,
                        multipleErrors: 0
                    };
                    
                    // íŒ€ì¥ ì´ë¦„ ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ ë§µ
                    const leaderNameCount = {};
                    for (let i = 1; i < jsonData.length; i++) {
                        const leaderName = jsonData[i][colIndices.teamLeader];
                        if (leaderName) {
                            const name = leaderName.toString().trim();
                            if (name) {
                                leaderNameCount[name] = (leaderNameCount[name] || 0) + 1;
                            }
                        }
                    }
                    
                    // ê° í–‰ ê²€ì‚¬ ë° ì˜¤ë¥˜ íƒ€ì… ì €ì¥
                    const rowErrors = [];
                    const newData = [headers]; // í—¤ë” ì¶”ê°€
                    
                    // ì˜¤ë¥˜ ë§ˆì»¤ ì¶”ê°€í•  ì—´ ì¸ë±ìŠ¤
                    const errorColumnIndex = headers.length;
                    newData[0].push('ê²€ì‚¬ê²°ê³¼'); // ìƒˆ ì—´ í—¤ë” ì¶”ê°€
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = [...jsonData[i]]; // í–‰ ë³µì‚¬
                        const errors = [];
                        let errorMessages = [];
                        
                        // 1. íŒ€ì¥ì´ë¦„ ì¤‘ë³µ ì²´í¬
                        const leaderName = row[colIndices.teamLeader];
                        if (leaderName) {
                            const name = leaderName.toString().trim();
                            if (name && leaderNameCount[name] > 1) {
                                errors.push('duplicate');
                                errorMessages.push('ã€ì¤‘ë³µã€‘íŒ€ì¥ì´ë¦„');
                                stats.duplicateLeader++;
                            }
                        }
                        
                        // 2. ë¯¸ì„±ë…„ì ì²´í¬ (2006ë…„ 8ì›” 21ì¼ ì´í›„)
                        const birthDate = row[colIndices.birthDate];
                        if (birthDate) {
                            const birthStr = birthDate.toString().trim();
                            // YYMMDD ë˜ëŠ” YYYYMMDD í˜•ì‹ ì²´í¬
                            if (birthStr.length === 6 || birthStr.length === 8) {
                                let year, month, day;
                                
                                if (birthStr.length === 6) {
                                    year = parseInt(birthStr.substring(0, 2));
                                    month = parseInt(birthStr.substring(2, 4));
                                    day = parseInt(birthStr.substring(4, 6));
                                    // 00-25ëŠ” 2000ë…„ëŒ€, 26-99ëŠ” 1900ë…„ëŒ€ë¡œ ê°€ì •
                                    year = year <= 25 ? 2000 + year : 1900 + year;
                                } else {
                                    year = parseInt(birthStr.substring(0, 4));
                                    month = parseInt(birthStr.substring(4, 6));
                                    day = parseInt(birthStr.substring(6, 8));
                                }
                                
                                // 2006ë…„ 8ì›” 21ì¼ ì´í›„ ì¶œìƒìëŠ” ë¯¸ì„±ë…„ì
                                if (year > 2006 || 
                                    (year === 2006 && month > 8) || 
                                    (year === 2006 && month === 8 && day > 21)) {
                                    errors.push('minor');
                                    errorMessages.push('ã€ë¯¸ì„±ë…„ã€‘');
                                    stats.minor++;
                                } else if (month > 12 || month < 1 || day > 31 || day < 1) {
                                    errors.push('minor');
                                    errorMessages.push('ã€ë‚ ì§œì˜¤ë¥˜ã€‘');
                                    stats.minor++;
                                }
                            } else if (birthStr.length > 0) {
                                // ì˜ëª»ëœ í˜•ì‹
                                errors.push('minor');
                                errorMessages.push('ã€ìƒë…„ì›”ì¼ì˜¤ë¥˜ã€‘');
                                stats.minor++;
                            }
                        }
                        
                        // 3. íŒ€ì¥ê³¼ íŒ€ì› ì´ë¦„ ë™ì¼ ì²´í¬
                        const teamMember = row[colIndices.teamMember];
                        if (leaderName && teamMember) {
                            const leaderStr = leaderName.toString().trim();
                            const memberStr = teamMember.toString().trim();
                            if (leaderStr && memberStr && leaderStr === memberStr) {
                                errors.push('sameName');
                                errorMessages.push('ã€ì´ë¦„ë™ì¼ã€‘');
                                stats.sameNames++;
                            }
                        }
                        
                        // 4. ì „í™”ë²ˆí˜¸ ì²´í¬ (11ìë¦¬)
                        const phone = row[colIndices.phone];
                        if (phone) {
                            const phoneStr = phone.toString().replace(/[^0-9]/g, '');
                            if (phoneStr.length > 0) {
                                // 0ì´ ì—†ìœ¼ë©´ ì¶”ê°€í•´ì„œ ì²´í¬
                                const phoneWithZero = phoneStr.startsWith('0') ? phoneStr : '0' + phoneStr;
                                if (phoneWithZero.length !== 11) {
                                    errors.push('wrongPhone');
                                    errorMessages.push('ã€ì „í™”ë²ˆí˜¸ã€‘');
                                    stats.wrongPhone++;
                                }
                            }
                        }
                        
                        // ë³µí•© ì˜¤ë¥˜ ì²´í¬
                        if (errors.length >= 2) {
                            stats.multipleErrors++;
                            row.push('â˜…â˜…' + errorMessages.join(' '));
                        } else if (errors.length === 1) {
                            row.push('â˜…' + errorMessages.join(' '));
                        } else {
                            row.push(''); // ì˜¤ë¥˜ ì—†ìŒ
                        }
                        
                        newData.push(row);
                        rowErrors.push(errors);
                    }
                    
                    // HTML í…Œì´ë¸” ìƒì„± (ë¯¸ë¦¬ë³´ê¸°ìš©)
                    let htmlTable = '<div style="margin: 20px 0; padding: 20px; background: white; border-radius: 10px; max-height: 400px; overflow: auto;">';
                    htmlTable += '<h3 style="color: #667eea; margin-bottom: 15px;">ê²€ì‚¬ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h3>';
                    htmlTable += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
                    htmlTable += '<thead><tr style="background: #f0f0f0;">';
                    
                    // í…Œì´ë¸” í—¤ë”
                    newData[0].forEach(header => {
                        htmlTable += `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${header}</th>`;
                    });
                    htmlTable += '</tr></thead><tbody>';
                    
                    // í…Œì´ë¸” ë³¸ë¬¸ (ì²˜ìŒ 20í–‰ë§Œ í‘œì‹œ)
                    const displayRows = Math.min(21, newData.length);
                    for (let i = 1; i < displayRows; i++) {
                        const errors = rowErrors[i - 1];
                        let bgColor = 'white';
                        let fontWeight = 'normal';
                        
                        if (errors.length >= 2) {
                            bgColor = '#8B6835'; // ê°ˆìƒ‰
                            fontWeight = 'bold';
                        } else if (errors.includes('duplicate')) {
                            bgColor = '#FF6B6B'; // ë¹¨ê°•
                        } else if (errors.includes('minor')) {
                            bgColor = '#51CF66'; // ë…¹ìƒ‰
                        } else if (errors.includes('sameName')) {
                            bgColor = '#FFD93D'; // ë…¸ë‘
                        } else if (errors.includes('wrongPhone')) {
                            bgColor = '#B197FC'; // ë³´ë¼
                        }
                        
                        htmlTable += `<tr style="background: ${bgColor}; color: ${bgColor !== 'white' ? 'white' : 'black'}; font-weight: ${fontWeight};">`;
                        newData[i].forEach(cell => {
                            htmlTable += `<td style="border: 1px solid #ddd; padding: 5px;">${cell || ''}</td>`;
                        });
                        htmlTable += '</tr>';
                    }
                    
                    if (newData.length > displayRows) {
                        htmlTable += `<tr><td colspan="${newData[0].length}" style="text-align: center; padding: 10px; color: #666;">... ì™¸ ${newData.length - displayRows}í–‰ ë” ìˆìŒ ...</td></tr>`;
                    }
                    
                    htmlTable += '</tbody></table></div>';
                    
                    // ìƒˆ ì›Œí¬ë¶ ìƒì„±
                    const newWorkbook = XLSX.utils.book_new();
                    const newSheet = XLSX.utils.aoa_to_sheet(newData);
                    
                    // ì—´ ë„ˆë¹„ ì„¤ì •
                    const colWidths = newData[0].map((header, i) => {
                        let maxLength = header ? header.toString().length : 10;
                        for (let j = 1; j < newData.length; j++) {
                            const cellValue = newData[j][i];
                            if (cellValue && cellValue.toString().length > maxLength) {
                                maxLength = cellValue.toString().length;
                            }
                        }
                        return { wch: Math.min(maxLength + 2, 50) };
                    });
                    newSheet['!cols'] = colWidths;
                    
                    // ì›Œí¬ë¶ì— ì‹œíŠ¸ ì¶”ê°€
                    XLSX.utils.book_append_sheet(newWorkbook, newSheet, sheetName);
                    
                    // íŒŒì¼ ì €ì¥
                    const newFileName = file.name.replace(/\.(xlsx|xls)$/, '_ê²€ì‚¬ì™„ë£Œ.xlsx');
                    XLSX.writeFile(newWorkbook, newFileName);
                    
                    // í†µê³„ í‘œì‹œ
                    statsBox.style.display = 'block';
                    statsGrid.innerHTML = `
                        <div class="stat-item">
                            <div class="stat-label">ì „ì²´ ë°ì´í„°</div>
                            <div class="stat-value">${stats.total}ê±´</div>
                        </div>
                        <div class="stat-item" style="background: rgba(255, 107, 107, 0.1);">
                            <div class="stat-label">íŒ€ì¥ì´ë¦„ ì¤‘ë³µ</div>
                            <div class="stat-value">${stats.duplicateLeader}ê±´</div>
                        </div>
                        <div class="stat-item" style="background: rgba(81, 207, 102, 0.1);">
                            <div class="stat-label">ë¯¸ì„±ë…„ì/ì˜¤ë¥˜</div>
                            <div class="stat-value">${stats.minor}ê±´</div>
                        </div>
                        <div class="stat-item" style="background: rgba(255, 217, 61, 0.1);">
                            <div class="stat-label">ì´ë¦„ ë™ì¼</div>
                            <div class="stat-value">${stats.sameNames}ê±´</div>
                        </div>
                        <div class="stat-item" style="background: rgba(177, 151, 252, 0.1);">
                            <div class="stat-label">ì „í™”ë²ˆí˜¸ ì˜¤ë¥˜</div>
                            <div class="stat-value">${stats.wrongPhone}ê±´</div>
                        </div>
                        <div class="stat-item" style="background: rgba(139, 104, 53, 0.1);">
                            <div class="stat-label">ë³µí•© ì˜¤ë¥˜</div>
                            <div class="stat-value">${stats.multipleErrors}ê±´</div>
                        </div>
                    `;
                    
                    // HTML í…Œì´ë¸”ì„ ìƒíƒœ ë©”ì‹œì§€ ë’¤ì— ì¶”ê°€
                    showStatus2(`âœ… ê²€ì‚¬ ì™„ë£Œ! "${newFileName}" ë‹¤ìš´ë¡œë“œë¨<br><small>â˜…í‘œì‹œê°€ ìˆëŠ” í–‰ì„ í™•ì¸í•˜ì„¸ìš”. (â˜…â˜…ëŠ” ë³µí•©ì˜¤ë¥˜)</small>`, 'success');
                    
                    // ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ì¶”ê°€
                    const previewDiv = document.createElement('div');
                    previewDiv.innerHTML = htmlTable;
                    statusDiv2.appendChild(previewDiv);
                    
                } catch (error) {
                    console.error('Error:', error);
                    showStatus2(`âŒ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                    statsBox.style.display = 'none';
                }
            };
            
            reader.onerror = function() {
                showStatus2('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨', 'error');
                statsBox.style.display = 'none';
            };
            
            reader.readAsBinaryString(file);
        }
    </script>
</body>
</html>