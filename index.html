// 테이블 본문 (처음 20행만 표시)
                    const displayRows = Math.min(21, newData.length);
                    for (let i = 1; i < displayRows; i++) {
                        const errors = rowErrors[i - 1];
                        let bgColor = 'white';
                        let fontWeight = 'normal';
                        
                        if (errors.length >= 2) {
                            bgColor = '#8B6835'; // 갈색 (복합 오류)
                            fontWeight = 'bold';
                        } else if (errors.includes('duplicate')) {
                            bgColor = '#FF6B6B'; // 빨강
                        } else if (errors.includes('swapDuplicate')) {
                            bgColor = '#FF9999'; // 연빨강
                        } else if (errors.includes('minor')) {
                            bgColor = '#51CF66'; // 녹색
                        } else if (errors.includes('sameName')) {
                            bgColor = '#FFD93D'; // 노랑
                        } else if (errors.includes('birthDuplicate')) {
                            bg<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>엑셀 파일 처리 프로그램</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            max-width: 1200px;
            width: 100%;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-wrapper {
            position: relative;
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
        }

        .upload-button {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            border: none;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .file-input {
            position: absolute;
            width: 0;
            height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.success {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%);
            color: #22543d;
            border: 1px solid rgba(72, 187, 120, 0.3);
            display: block;
        }

        .status.error {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(237, 64, 64, 0.1) 100%);
            color: #742a2a;
            border: 1px solid rgba(245, 101, 101, 0.3);
            display: block;
        }

        .status.processing {
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.1) 0%, rgba(49, 130, 206, 0.1) 100%);
            color: #2c5282;
            border: 1px solid rgba(66, 153, 225, 0.3);
            display: block;
        }

        .info-box {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .info-box ul {
            list-style: none;
            color: #666;
            font-size: 14px;
            line-height: 1.8;
        }

        .info-box ul li:before {
            content: "✓ ";
            color: #667eea;
            font-weight: bold;
            margin-right: 5px;
        }

        .color-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .loader {
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .stats-box h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-item {
            padding: 8px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 5px;
            font-size: 14px;
        }

        .stat-label {
            color: #888;
            font-size: 12px;
        }

        .stat-value {
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 첫 번째 프로그램: 솔팅 -->
        <div class="container">
            <h1>📊 엑셀 파일 솔팅 프로그램</h1>
            
            <div class="info-box">
                <h3>처리 내용</h3>
                <ul>
                    <li>All 시트에서 필요한 열만 추출</li>
                    <li>보존 열: Event Name, First Name, Last Name, 런제주2025, 나이키, 250821, 홍길동, 250905, 010 1234 5678</li>
                    <li>열 이름 변경: 나이키→팀장이름, 250821→팀장 생년월일, 홍길동→팀원이름, 250905→팀원 생년월일, 010 1234 5678→전화번호</li>
                    <li>생년월일 자동 정리: 5자리인 경우 앞에 0 추가 (예: 50821 → 050821)</li>
                    <li>전화번호 자동 정리: 0 추가 및 3-4-4 형식으로 변환</li>
                    <li>파일명에 "_솔팅" 추가</li>
                </ul>
            </div>

            <div class="upload-wrapper">
                <div class="upload-area" id="uploadArea1">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">엑셀 파일을 드래그하여 업로드</div>
                    <label for="fileInput1" class="upload-button">파일 선택</label>
                </div>
                <input type="file" id="fileInput1" class="file-input" accept=".xlsx,.xls">
            </div>

            <div id="status1" class="status"></div>
        </div>

        <!-- 두 번째 프로그램: 중복 검사 -->
        <div class="container">
            <h2>🔍 중복 및 오류 검사 프로그램</h2>
            
            <div class="info-box">
                <h3>검사 항목 및 색상 표시</h3>
                <div class="color-legend">
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #DC143C;"></div>
                        <span>팀장이름+전화번호 동일 (진빨강)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #FF9999;"></div>
                        <span>팀장팀원 바꿔 중복 (연빨강)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #51CF66;"></div>
                        <span>미성년자/잘못된 생년월일 (녹색)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #FFD93D;"></div>
                        <span>팀장/팀원 이름 동일 (노랑)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #FFA500;"></div>
                        <span>전화번호 중복 (주황)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #B197FC;"></div>
                        <span>잘못된 전화번호 (보라)</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #8B6835;"></div>
                        <span>복합 오류 (갈색)</span>
                    </div>
                </div>
            </div>

            <div class="upload-wrapper">
                <div class="upload-area" id="uploadArea2">
                    <div class="upload-icon">📋</div>
                    <div class="upload-text">솔팅된 엑셀 파일을 드래그하여 업로드</div>
                    <label for="fileInput2" class="upload-button">파일 선택</label>
                </div>
                <input type="file" id="fileInput2" class="file-input" accept=".xlsx,.xls">
            </div>

            <div id="status2" class="status"></div>
            <div id="statsBox" class="stats-box" style="display: none;">
                <h4>검사 결과 통계</h4>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // 페이지 로드 시 드래그 앤 드롭 방지
        window.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, false);
        
        window.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, false);

        // 첫 번째 프로그램 (솔팅)
        const uploadArea1 = document.getElementById('uploadArea1');
        const fileInput1 = document.getElementById('fileInput1');
        const statusDiv1 = document.getElementById('status1');

        // 파일 선택 이벤트
        fileInput1.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleSortingFile(e.target.files[0]);
            }
        });

        // 드래그 오버
        uploadArea1.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea1.classList.add('dragover');
        });

        // 드래그 떠남
        uploadArea1.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea1.classList.remove('dragover');
        });

        // 드롭
        uploadArea1.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea1.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                handleSortingFile(files[0]);
            }
        });

        function showStatus1(message, type) {
            statusDiv1.className = 'status ' + type;
            statusDiv1.innerHTML = message;
        }

        function handleSortingFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus1('❌ 엑셀 파일(.xlsx, .xls)만 업로드 가능합니다.', 'error');
                return;
            }

            showStatus1('<div class="loader"></div>파일 처리 중...', 'processing');

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    
                    if (!workbook.Sheets['All']) {
                        showStatus1('❌ "All" 시트를 찾을 수 없습니다.', 'error');
                        return;
                    }
                    
                    const allSheet = workbook.Sheets['All'];
                    const jsonData = XLSX.utils.sheet_to_json(allSheet, { header: 1 });
                    
                    if (jsonData.length === 0) {
                        showStatus1('❌ 데이터가 없습니다.', 'error');
                        return;
                    }
                    
                    const headers = jsonData[0];
                    const columnsToKeep = ['Event Name', 'First Name', 'Last Name', '런제주2025', '나이키', '250821', '홍길동', '250905', '010 1234 5678'];
                    const columnIndices = [];
                    const columnMapping = {};
                    
                    columnsToKeep.forEach(colName => {
                        const index = headers.findIndex(header => {
                            if (!header) return false;
                            const headerStr = header.toString().trim();
                            return headerStr === colName || 
                                   headerStr.includes(colName) || 
                                   colName.includes(headerStr);
                        });
                        
                        if (index !== -1) {
                            columnIndices.push(index);
                            columnMapping[index] = colName;
                        }
                    });
                    
                    if (columnIndices.length === 0) {
                        showStatus1('❌ 필요한 열을 찾을 수 없습니다.', 'error');
                        return;
                    }
                    
                    // 전화번호 포맷팅 함수
                    function formatPhoneNumber(phone) {
                        if (!phone) return '';
                        
                        // 숫자만 추출
                        let phoneStr = phone.toString().replace(/[^0-9]/g, '');
                        
                        // 0이 없으면 추가
                        if (phoneStr.length > 0 && !phoneStr.startsWith('0')) {
                            phoneStr = '0' + phoneStr;
                        }
                        
                        // 11자리인 경우 3-4-4 형식으로 변환
                        if (phoneStr.length === 11) {
                            return phoneStr.substring(0, 3) + '-' + 
                                   phoneStr.substring(3, 7) + '-' + 
                                   phoneStr.substring(7, 11);
                        }
                        
                        return phoneStr; // 11자리가 아닌 경우 그대로 반환
                    }
                    
                    // 생년월일 포맷팅 함수 (5자리인 경우 앞에 0 추가)
                    function formatBirthDate(birthDate) {
                        if (!birthDate) return '';
                        
                        // 숫자만 추출
                        let birthStr = birthDate.toString().replace(/[^0-9]/g, '');
                        
                        // 5자리인 경우 앞에 0 추가 (예: 50821 -> 050821)
                        if (birthStr.length === 5) {
                            birthStr = '0' + birthStr;
                        }
                        
                        return birthStr;
                    }
                    
                    const newData = [];
                    const newHeaders = columnIndices.map(index => {
                        const originalHeader = headers[index];
                        const mappedName = columnMapping[index];
                        
                        if (originalHeader.toString().includes('나이키') || mappedName === '나이키') {
                            return '팀장이름';
                        } else if (originalHeader.toString().includes('250821') || mappedName === '250821') {
                            return '팀장 생년월일';
                        } else if (originalHeader.toString().includes('홍길동') || mappedName === '홍길동') {
                            return '팀원이름';
                        } else if (originalHeader.toString().includes('250905') || mappedName === '250905') {
                            return '팀원 생년월일';
                        } else if (originalHeader.toString().includes('010') || mappedName === '010 1234 5678') {
                            return '전화번호';
                        } else {
                            return originalHeader;
                        }
                    });
                    
                    newData.push(newHeaders);
                    
                    // 전화번호 열 인덱스 찾기
                    const phoneColumnIndex = newHeaders.findIndex(h => h === '전화번호');
                    // 팀장 생년월일 열 인덱스 찾기
                    const leaderBirthIndex = newHeaders.findIndex(h => h === '팀장 생년월일');
                    // 팀원 생년월일 열 인덱스 찾기
                    const memberBirthIndex = newHeaders.findIndex(h => h === '팀원 생년월일');
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const newRow = columnIndices.map((index, colIdx) => {
                            const value = row[index] || '';
                            
                            // 전화번호 열인 경우 포맷팅 적용
                            if (colIdx === phoneColumnIndex) {
                                return formatPhoneNumber(value);
                            }
                            
                            // 팀장 생년월일 열인 경우 포맷팅 적용
                            if (colIdx === leaderBirthIndex) {
                                return formatBirthDate(value);
                            }
                            
                            // 팀원 생년월일 열인 경우 포맷팅 적용
                            if (colIdx === memberBirthIndex) {
                                return formatBirthDate(value);
                            }
                            
                            return value;
                        });
                        newData.push(newRow);
                    }
                    
                    const newWorkbook = XLSX.utils.book_new();
                    const newWorksheet = XLSX.utils.aoa_to_sheet(newData);
                    
                    const colWidths = newHeaders.map((header, i) => {
                        let maxLength = header.length;
                        for (let j = 1; j < newData.length; j++) {
                            const cellValue = newData[j][i];
                            if (cellValue && cellValue.toString().length > maxLength) {
                                maxLength = cellValue.toString().length;
                            }
                        }
                        return { wch: Math.min(maxLength + 2, 50) };
                    });
                    newWorksheet['!cols'] = colWidths;
                    
                    XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'All');
                    
                    const newFileName = file.name.replace(/\.(xlsx|xls)$/, '_솔팅.xlsx');
                    XLSX.writeFile(newWorkbook, newFileName);
                    
                    showStatus1('✅ 파일 처리 완료! "' + newFileName + '" 다운로드됨<br>처리된 열: ' + columnIndices.length + '개<br>전화번호 자동 포맷팅 완료', 'success');
                    
                } catch (error) {
                    console.error('Error:', error);
                    showStatus1('❌ 파일 처리 중 오류 발생: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus1('❌ 파일 읽기 실패', 'error');
            };
            
            reader.readAsBinaryString(file);
        }

        // 두 번째 프로그램 (중복 검사)
        const uploadArea2 = document.getElementById('uploadArea2');
        const fileInput2 = document.getElementById('fileInput2');
        const statusDiv2 = document.getElementById('status2');
        const statsBox = document.getElementById('statsBox');
        const statsGrid = document.getElementById('statsGrid');

        // 파일 선택 이벤트
        fileInput2.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleDuplicateCheck(e.target.files[0]);
            }
        });

        // 드래그 오버
        uploadArea2.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea2.classList.add('dragover');
        });

        // 드래그 떠남
        uploadArea2.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea2.classList.remove('dragover');
        });

        // 드롭
        uploadArea2.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea2.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                handleDuplicateCheck(files[0]);
            }
        });

        function showStatus2(message, type) {
            statusDiv2.className = 'status ' + type;
            statusDiv2.innerHTML = message;
        }

        function handleDuplicateCheck(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus2('❌ 엑셀 파일(.xlsx, .xls)만 업로드 가능합니다.', 'error');
                return;
            }

            showStatus2('<div class="loader"></div>중복 및 오류 검사 중...', 'processing');

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { 
                        type: 'binary'
                    });
                    
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    
                    if (jsonData.length === 0) {
                        showStatus2('❌ 데이터가 없습니다.', 'error');
                        return;
                    }
                    
                    const headers = jsonData[0];
                    
                    // 열 인덱스 찾기
                    const colIndices = {
                        eventName: headers.findIndex(h => h && h.toString().includes('Event Name')),
                        runJeju: headers.findIndex(h => h && h.toString().includes('런제주')),
                        teamLeader: headers.findIndex(h => h && h.toString().includes('팀장이름')),
                        leaderBirth: headers.findIndex(h => h && h.toString().includes('팀장 생년월일')),
                        teamMember: headers.findIndex(h => h && h.toString().includes('팀원이름')),
                        memberBirth: headers.findIndex(h => h && h.toString().includes('팀원 생년월일')),
                        phone: headers.findIndex(h => h && h.toString().includes('전화번호'))
                    };
                    
                    // 통계 초기화
                    const stats = {
                        total: jsonData.length - 1,
                        leaderPhoneSame: 0,
                        swapDuplicate: 0,
                        minor: 0,
                        sameNames: 0,
                        phoneDuplicate: 0,
                        wrongPhone: 0,
                        multipleErrors: 0
                    };
                    
                    // 중복 체크를 위한 맵
                    const leaderPhoneCombo = {}; // 팀장이름+전화번호 조합 체크용
                    const teamPairMap = {}; // 팀장-팀원 조합 체크용
                    const phoneCount = {}; // 전화번호 중복 체크용
                    
                    // 첫 번째 패스: 모든 데이터 수집
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        
                        // 팀장이름+전화번호 조합 체크
                        const leaderName = row[colIndices.teamLeader];
                        const phone = row[colIndices.phone];
                        if (leaderName && phone) {
                            const name = leaderName.toString().trim();
                            const phoneStr = phone.toString().replace(/[^0-9]/g, '');
                            if (name && phoneStr) {
                                const comboKey = name + '_' + phoneStr;
                                leaderPhoneCombo[comboKey] = (leaderPhoneCombo[comboKey] || 0) + 1;
                            }
                        }
                        
                        // 팀장-팀원 조합 저장 (순서 바꾼 중복 체크용)
                        const teamMember = row[colIndices.teamMember];
                        if (leaderName && teamMember) {
                            const leader = leaderName.toString().trim();
                            const member = teamMember.toString().trim();
                            if (leader && member) {
                                const pairKey = [leader, member].sort().join('-');
                                if (!teamPairMap[pairKey]) {
                                    teamPairMap[pairKey] = [];
                                }
                                teamPairMap[pairKey].push({
                                    index: i,
                                    leader: leader,
                                    member: member
                                });
                            }
                        }
                        
                        // 전화번호 카운트
                        if (phone) {
                            const phoneStr = phone.toString().replace(/[^0-9]/g, '');
                            if (phoneStr) {
                                phoneCount[phoneStr] = (phoneCount[phoneStr] || 0) + 1;
                            }
                        }
                    }
                    
                    // 각 행 검사
                    const newData = [headers]; // 헤더 추가
                    newData[0].push('검사결과'); // 새 열 헤더 추가
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = [...jsonData[i]]; // 행 복사
                        const errors = [];
                        let errorMessages = [];
                        
                        // 1. 팀장이름+전화번호 동일 체크 (실제 같은 사람)
                        const leaderName = row[colIndices.teamLeader];
                        const phone = row[colIndices.phone];
                        if (leaderName && phone) {
                            const name = leaderName.toString().trim();
                            const phoneStr = phone.toString().replace(/[^0-9]/g, '');
                            if (name && phoneStr) {
                                const comboKey = name + '_' + phoneStr;
                                if (leaderPhoneCombo[comboKey] > 1) {
                                    errors.push('leaderPhoneSame');
                                    errorMessages.push('팀장이름전번동일');
                                    stats.leaderPhoneSame++;
                                }
                            }
                        }
                        
                        // 2. 팀장-팀원 바꿔서 중복 체크
                        const teamMember = row[colIndices.teamMember];
                        if (leaderName && teamMember) {
                            const leader = leaderName.toString().trim();
                            const member = teamMember.toString().trim();
                            if (leader && member) {
                                const pairKey = [leader, member].sort().join('-');
                                const pairs = teamPairMap[pairKey];
                                if (pairs && pairs.length > 1) {
                                    // 현재 행과 다른 조합이 있는지 체크
                                    const hasSwapped = pairs.some(p => 
                                        p.index !== i && 
                                        (p.leader !== leader || p.member !== member)
                                    );
                                    if (hasSwapped) {
                                        errors.push('swapDuplicate');
                                        errorMessages.push('팀장팀원바꿔중복');
                                        stats.swapDuplicate++;
                                    }
                                }
                            }
                        }
                        
                        // 3. 미성년자 체크 - 팀장과 팀원 모두 확인 (2006년 8월 21일 이후)
                        const leaderBirth = row[colIndices.leaderBirth];
                        const memberBirth = row[colIndices.memberBirth];
                        
                        // 팀장 생년월일 체크
                        if (leaderBirth) {
                            const birthStr = leaderBirth.toString().trim();
                            if (birthStr.length === 6 || birthStr.length === 8) {
                                let year, month, day;
                                
                                if (birthStr.length === 6) {
                                    year = parseInt(birthStr.substring(0, 2));
                                    month = parseInt(birthStr.substring(2, 4));
                                    day = parseInt(birthStr.substring(4, 6));
                                    year = year <= 25 ? 2000 + year : 1900 + year;
                                } else {
                                    year = parseInt(birthStr.substring(0, 4));
                                    month = parseInt(birthStr.substring(4, 6));
                                    day = parseInt(birthStr.substring(6, 8));
                                }
                                
                                if (year > 2006 || 
                                    (year === 2006 && month > 8) || 
                                    (year === 2006 && month === 8 && day > 21)) {
                                    errors.push('minor');
                                    errorMessages.push('팀장미성년');
                                    stats.minor++;
                                } else if (month > 12 || month < 1 || day > 31 || day < 1) {
                                    errors.push('minor');
                                    errorMessages.push('팀장생년오류');
                                    stats.minor++;
                                }
                            } else if (birthStr.length > 0) {
                                errors.push('minor');
                                errorMessages.push('팀장생년오류');
                                stats.minor++;
                            }
                        }
                        
                        // 팀원 생년월일 체크
                        if (memberBirth) {
                            const birthStr = memberBirth.toString().trim();
                            if (birthStr.length === 6 || birthStr.length === 8) {
                                let year, month, day;
                                
                                if (birthStr.length === 6) {
                                    year = parseInt(birthStr.substring(0, 2));
                                    month = parseInt(birthStr.substring(2, 4));
                                    day = parseInt(birthStr.substring(4, 6));
                                    year = year <= 25 ? 2000 + year : 1900 + year;
                                } else {
                                    year = parseInt(birthStr.substring(0, 4));
                                    month = parseInt(birthStr.substring(4, 6));
                                    day = parseInt(birthStr.substring(6, 8));
                                }
                                
                                if (year > 2006 || 
                                    (year === 2006 && month > 8) || 
                                    (year === 2006 && month === 8 && day > 21)) {
                                    errors.push('minor');
                                    errorMessages.push('팀원미성년');
                                    stats.minor++;
                                } else if (month > 12 || month < 1 || day > 31 || day < 1) {
                                    errors.push('minor');
                                    errorMessages.push('팀원생년오류');
                                    stats.minor++;
                                }
                            } else if (birthStr.length > 0) {
                                errors.push('minor');
                                errorMessages.push('팀원생년오류');
                                stats.minor++;
                            }
                        }
                        
                        // 4. 팀장과 팀원 이름 동일 체크
                        if (leaderName && teamMember) {
                            const leaderStr = leaderName.toString().trim();
                            const memberStr = teamMember.toString().trim();
                            if (leaderStr && memberStr && leaderStr === memberStr) {
                                errors.push('sameName');
                                errorMessages.push('이름동일');
                                stats.sameNames++;
                            }
                        }
                        
                        // 5. 전화번호 중복 체크
                        if (phone) {
                            const phoneStr = phone.toString().replace(/[^0-9]/g, '');
                            if (phoneStr && phoneCount[phoneStr] > 1) {
                                errors.push('phoneDuplicate');
                                errorMessages.push('전화번호중복');
                                stats.phoneDuplicate++;
                            }
                        }
                        
                        // 6. 전화번호 형식 체크 (11자리)
                        if (phone) {
                            const phoneStr = phone.toString().replace(/[^0-9]/g, '');
                            if (phoneStr.length > 0) {
                                const phoneWithZero = phoneStr.startsWith('0') ? phoneStr : '0' + phoneStr;
                                if (phoneWithZero.length !== 11) {
                                    errors.push('wrongPhone');
                                    errorMessages.push('전화번호오류');
                                    stats.wrongPhone++;
                                }
                            }
                        }
                        
                        // 복합 오류 체크 및 결과 메시지 생성
                        if (errors.length >= 2) {
                            stats.multipleErrors++;
                            // 복합 오류일 경우 처음 2개 항목만 표시
                            row.push('★★【' + errorMessages.slice(0, 2).join('+') + '】');
                        } else if (errors.length === 1) {
                            row.push('★【' + errorMessages[0] + '】');
                        } else {
                            row.push(''); // 오류 없음
                        }
                        
                        newData.push(row);
                    }
                    
                    // 새 워크북 생성
                    const newWorkbook = XLSX.utils.book_new();
                    const newSheet = XLSX.utils.aoa_to_sheet(newData);
                    
                    // 열 너비 설정
                    const colWidths = newData[0].map((header, i) => {
                        let maxLength = header ? header.toString().length : 10;
                        for (let j = 1; j < newData.length; j++) {
                            const cellValue = newData[j][i];
                            if (cellValue && cellValue.toString().length > maxLength) {
                                maxLength = cellValue.toString().length;
                            }
                        }
                        return { wch: Math.min(maxLength + 2, 50) };
                    });
                    newSheet['!cols'] = colWidths;
                    
                    // 워크북에 시트 추가
                    XLSX.utils.book_append_sheet(newWorkbook, newSheet, sheetName);
                    
                    // 파일 저장
                    const newFileName = file.name.replace(/\.(xlsx|xls)$/, '_검사완료.xlsx');
                    XLSX.writeFile(newWorkbook, newFileName);
                    
                    // 통계 표시
                    statsBox.style.display = 'block';
                    statsGrid.innerHTML = `
                        <div class="stat-item">
                            <div class="stat-label">전체 데이터</div>
                            <div class="stat-value">${stats.total}건</div>
                        </div>
                        <div class="stat-item" style="background: rgba(255, 107, 107, 0.1);">
                            <div class="stat-label">팀장이름 중복</div>
                            <div class="stat-value">${stats.duplicateLeader}건</div>
                        </div>
                        <div class="stat-item" style="background: rgba(81, 207, 102, 0.1);">
                            <div class="stat-label">미성년자/오류</div>
                            <div class="stat-value">${stats.minor}건</div>
                        </div>
                        <div class="stat-item" style="background: rgba(255, 217, 61, 0.1);">
                            <div class="stat-label">이름 동일</div>
                            <div class="stat-value">${stats.sameNames}건</div>
                        </div>
                        <div class="stat-item" style="background: rgba(177, 151, 252, 0.1);">
                            <div class="stat-label">전화번호 오류</div>
                            <div class="stat-value">${stats.wrongPhone}건</div>
                        </div>
                        <div class="stat-item" style="background: rgba(139, 104, 53, 0.1);">
                            <div class="stat-label">복합 오류</div>
                            <div class="stat-value">${stats.multipleErrors}건</div>
                        </div>
                    `;
                    
                    // HTML 테이블을 상태 메시지 뒤에 추가
                    showStatus2(`✅ 검사 완료! "${newFileName}" 다운로드됨<br><small>★표시가 있는 행을 확인하세요. (★★는 복합오류)</small>`, 'success');
                    
                    // 미리보기 테이블 추가
                    const previewDiv = document.createElement('div');
                    previewDiv.innerHTML = htmlTable;
                    statusDiv2.appendChild(previewDiv);
                    
                } catch (error) {
                    console.error('Error:', error);
                    showStatus2('❌ 파일 처리 중 오류 발생: ' + error.message, 'error');
                    statsBox.style.display = 'none';
                }
            };
            
            reader.onerror = function() {
                showStatus2('❌ 파일 읽기 실패', 'error');
                statsBox.style.display = 'none';
            };
            
            reader.readAsBinaryString(file);
        }
    </script>
</body>
</html>
